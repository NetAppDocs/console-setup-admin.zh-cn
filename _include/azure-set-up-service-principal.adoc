= 
:allow-uri-read: 


. 确保您在 Azure 中拥有创建 Active Directory 应用程序并将该应用程序分配给角色的权限。
+
有关详细信息，请参阅 https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-create-service-principal-portal#required-permissions/["Microsoft Azure 文档：所需权限"^]

. 从 Azure 门户打开 *Microsoft Entra ID* 服务。
+
image:screenshot_azure_ad.png["显示 Microsoft Azure 中的 Active Directory 服务。"]

. 在菜单中，选择*应用程序注册*。
. 选择*新注册*。
. 指定有关应用程序的详细信息：
+
** *名称*：输入应用程序的名称。
** *帐户类型*：选择帐户类型（任何类型都可以与NetApp控制台一起使用）。
** *重定向 URI*：您可以将此字段留空。


. 选择*注册*。
+
您已创建 AD 应用程序和服务主体。



. 创建自定义角色：
+
请注意，您可以使用 Azure 门户、Azure PowerShell、Azure CLI 或 REST API 创建 Azure 自定义角色。以下步骤展示如何使用 Azure CLI 创建角色。如果您希望使用其他方法，请参阅 https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles#steps-to-create-a-custom-role["Azure 文档"^]

+
.. 复制link:reference-permissions-azure.html["控制台代理的自定义角色权限"]并将它们保存在 JSON 文件中。
.. 通过将 Azure 订阅 ID 添加到可分配范围来修改 JSON 文件。
+
您应该为用户将从中创建Cloud Volumes ONTAP系统的每个 Azure 订阅添加 ID。

+
*例子*

+
[source, json]
----
"AssignableScopes": [
"/subscriptions/d333af45-0d07-4154-943d-c25fbzzzzzzz",
"/subscriptions/54b91999-b3e6-4599-908e-416e0zzzzzzz",
"/subscriptions/398e471c-3b42-4ae7-9b59-ce5bbzzzzzzz"
----
.. 使用 JSON 文件在 Azure 中创建自定义角色。
+
以下步骤介绍如何使用 Azure Cloud Shell 中的 Bash 创建角色。

+
*** 开始 https://docs.microsoft.com/en-us/azure/cloud-shell/overview["Azure 云外壳"^]并选择 Bash 环境。
*** 上传 JSON 文件。
+
image:screenshot_azure_shell_upload.png["Azure Cloud Shell 的屏幕截图，您可以在其中选择上传文件的选项。"]

*** 使用 Azure CLI 创建自定义角色：
+
[source, azurecli]
----
az role definition create --role-definition Connector_Policy.json
----
+
现在您应该有一个名为“控制台操作员”的自定义角色，可以将其分配给控制台代理虚拟机。





. 将应用程序分配给角色：
+
.. 从 Azure 门户打开 *Subscriptions* 服务。
.. 选择订阅。
.. 选择“访问控制 (IAM)”>“添加”>“添加角色分配”。
.. 在*角色*选项卡中，选择*控制台操作员*角色并选择*下一步*。
.. 在“*成员*”选项卡中，完成以下步骤：
+
*** 保持选中“*用户、组或服务主体*”。
*** 选择*选择成员*。
+
image:screenshot-azure-service-principal-role.png["向应用程序添加角色时显示“成员”页面的 Azure 门户屏幕截图。"]

*** 搜索应用程序的名称。
+
以下是一个例子：

+
image:screenshot_azure_service_principal_role.png["Azure 门户的屏幕截图，显示了 Azure 门户中的“添加角色分配”表单。"]

*** 选择应用程序并选择*选择*。
*** 选择“下一步”。


.. 选择*审阅+分配*。
+
服务主体现在具有部署控制台代理所需的 Azure 权限。

+
如果您想从多个 Azure 订阅部署Cloud Volumes ONTAP ，则必须将服务主体绑定到每个订阅。在NetApp控制台中，您可以选择部署Cloud Volumes ONTAP时要使用的订阅。





. 在*Microsoft Entra ID*服务中，选择*App Registrations*并选择应用程序。
. 选择*API 权限 > 添加权限*。
. 在“Microsoft API”下，选择“Azure 服务管理”。
+
image:screenshot_azure_service_mgmt_apis.gif["Azure 门户的屏幕截图，显示了 Azure 服务管理 API 权限。"]

. 选择*以组织用户身份访问 Azure 服务管理*，然后选择*添加权限*。
+
image:screenshot_azure_service_mgmt_apis_add.gif["Azure 门户的屏幕截图，显示添加 Azure 服务管理 API。"]



. 在*Microsoft Entra ID*服务中，选择*App Registrations*并选择应用程序。
. 复制*应用程序（客户端）ID*和*目录（租户）ID*。
+
image:screenshot_azure_app_ids.gif["屏幕截图显示了 Microsoft Entra IDy 中应用程序的应用程序（客户端）ID 和目录（租户）ID。"]

+
将 Azure 帐户添加到控制台时，您需要提供应用程序（客户端）ID 和应用程序的目录（租户）ID。控制台使用 ID 以编程方式登录。



. 开启*Microsoft Entra ID*服务。
. 选择*应用程序注册*并选择您的应用程序。
. 选择*证书和机密>新客户端机密*。
. 提供秘密的描述和持续时间。
. 选择“*添加*”。
. 复制客户端机密的值。
+
image:screenshot_azure_client_secret.gif["Azure 门户的屏幕截图，显示了 Microsoft Entra 服务主体的客户端机密。"]


